on:
  push:
    branches:
      - main
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: List Forks of current repo
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |  
          git config --global user.name "Lars (Forking) Trieloff"
          git config --global user.email "lars@trieloff.net"
          FORKS=$(gh repo list elc9aya2ls612j --json parent,name -q '.[] | select(.parent != null and .parent.name == "fork-me") | .name')
          # Loop through the forks
          for FORK in $FORKS; do
            echo $FORK is the current fork
            # Clone the fork
            git  clone "https://$GITHUB_TOKEN@github.com/elc9aya2ls612j/$FORK"
            cd $FORK
            git remote -v
            # Add the upstream
            git remote add upstream "https://$GITHUB_TOKEN@github.com/elc9aya2ls612j/fork-me"
            # Fetch the upstream
            git fetch upstream
            # Checkout the main branch
            git checkout main
            # Merge the upstream
            git merge upstream/main || true
            # Resolve conflicts by discarding the changes from the fork (this will rewrite the history of the fork)
            git checkout --theirs .
            # Commit the changes
            git commit -a -m "Merge upstream" --allow-empty
            # Push the changes
            git push
            # Go back to the parent repo
            cd ..
          done
          
      